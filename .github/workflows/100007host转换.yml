name: Update Hosts for Mihomo

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间00:00运行
  workflow_dispatch:     # 允许手动触发

jobs:
  process-hosts:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create directories
      run: |
        mkdir -p hosts
        mkdir -p yaml

    - name: Download hosts file
      run: |
        curl -s https://raw.githubusercontent.com/lingeringsound/10007/main/all > hosts/raw_hosts.txt

    - name: Process and convert hosts
      run: |
        # 提取0.0.0.0开头的行并转换为YAML格式
        grep '^0\.0\.0\.0' hosts/raw_hosts.txt | \
        awk '{print "  - "$2}' > yaml/mihomo_rules.yaml
        
        # 添加YAML文件头
        echo "payload:" | cat - yaml/mihomo_rules.yaml > temp && mv temp yaml/mihomo_rules.yaml
        
        # 添加文件尾（可选）
        echo "# 规则已自动生成于 $(date)" >> yaml/mihomo_rules.yaml

    - name: Commit changes
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add yaml/
        git commit -m "自动更新mihomo规则 [skip ci]" || echo "无变化无需提交"
        git push

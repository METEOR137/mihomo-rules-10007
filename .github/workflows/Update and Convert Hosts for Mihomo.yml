name: 更新并转换规则集

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间00:00运行
  workflow_dispatch:     # 允许手动触发

env:
  MIHOMO_VERSION: "v1.19.15"
  TZ: "Asia/Shanghai"

jobs:
  process-and-convert:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 创建目录结构
        run: |
          mkdir -p {hosts,yaml,mrs,logs}

      - name: 下载hosts源文件
        run: |
          curl -fLsS -o hosts/10007hosts.txt \
            https://raw.githubusercontent.com/lingeringsound/10007/main/all
        continue-on-error: false

      - name: 转换hosts为YAML格式
        run: |
          {
            echo "payload:"
            grep '^0\.0\.0\.0' hosts/10007hosts.txt | \
            awk '{gsub(/\.$/, "", $2); print "  - "$2}' | \
            sed '/^[[:space:]]*-[[:space:]]*$/d'
          } > yaml/10007hosts.yaml
          
          if [ ! -s yaml/10007hosts.yaml ]; then
            echo "错误：YAML文件为空，可能无有效规则"
            exit 1
          fi

      - name: 下载并验证mihomo转换工具
        run: |
          # 根据mihomo实际发布页面的文件名格式调整
          MI_BASE_URL="https://github.com/MetaCubeX/mihomo/releases/download"
          MI_VERSION="${MIHOMO_VERSION#v}"  # 去掉v前缀，如v1.19.15 -> 1.19.15
          MI_FILE="mihomo-linux-amd64-v3-${MI_VERSION}"
          
          echo "下载mihomo: ${MI_BASE_URL}/${MIHOMO_VERSION}/${MI_FILE}.gz"
          
          # 下载文件，添加重试机制
          if ! curl -fLsS -o "${MI_FILE}.gz" "${MI_BASE_URL}/${MIHOMO_VERSION}/${MI_FILE}.gz"; then
            echo "错误：下载失败，请检查网络或URL"
            echo "尝试备用文件名格式..."
            # 尝试另一种文件名格式
            MI_FILE_ALT="mihomo-linux-amd64-v3-${MIHOMO_VERSION}"
            curl -fLsS -o "${MI_FILE_ALT}.gz" "${MI_BASE_URL}/${MIHOMO_VERSION}/${MI_FILE_ALT}.gz" || {
              echo "备用下载也失败"
              exit 1
            }
            MI_FILE="${MI_FILE_ALT}"
          fi
          
          # 检查文件大小
          if [ ! -s "${MI_FILE}.gz" ]; then
            echo "错误：下载文件为空"
            exit 1
          fi
          
          echo "解压文件..."
          gzip -d "${MI_FILE}.gz"
          
          if [ ! -f "${MI_FILE}" ]; then
            echo "错误：解压失败"
            exit 1
          fi
          
          chmod +x "${MI_FILE}"
          mv "${MI_FILE}" mihomo
          
          echo "验证mihomo版本..."
          # 使用 -v 参数检查版本，并捕获输出
          VERSION_OUTPUT=$(./mihomo -v 2>&1)
          if echo "${VERSION_OUTPUT}" | grep -q -i "mihomo\|clash\|meta"; then
            echo "✓ mihomo验证成功"
            echo "${VERSION_OUTPUT}"
          else
            echo "错误：mihomo验证失败，输出如下："
            echo "${VERSION_OUTPUT}"
            echo "文件信息："
            file ./mihomo
            exit 1
          fi

      - name: 执行规则集转换
        run: |
          # 临时禁用 set -e，避免算术表达式导致意外退出
          set +e
          
          success_count=0
          fail_count=0
          
          for yaml_file in yaml/*.yaml; do
            base_name=$(basename "$yaml_file" .yaml)
            output_file="mrs/${base_name}.mrs"
            
            echo "正在转换: ${yaml_file}"
            
            if timeout 60s ./mihomo convert-ruleset domain yaml "${yaml_file}" "${output_file}" 2>>logs/convert.log; then
              if [ -s "${output_file}" ]; then
                echo "✓ 成功生成: ${output_file}"
                # 使用不会返回假值的算术表达式
                success_count=$((success_count + 1))
              else
                echo "⚠ 生成文件为空，跳过"
                rm -f "${output_file}"
                fail_count=$((fail_count + 1))
              fi
            else
              echo "✗ 转换失败: ${yaml_file}"
              fail_count=$((fail_count + 1))
            fi
          done
          
          # 重新启用错误检查
          set -e
          
          echo "转换完成: ${success_count} 成功, ${fail_count} 失败"
          
          if [ ${success_count} -eq 0 ]; then
            echo "无成功转换文件，任务终止"
            exit 1
          fi

      - name: 准备发布内容
        run: |
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC+8')
          
          cat > release_body.md <<EOF
          规则集自动转换结果
          生成时间: ${CURRENT_TIME}
          
          包含文件:
          EOF
          
          for mrs_file in mrs/*.mrs; do
            if [ -f "${mrs_file}" ]; then
              file_size=$(stat -c%s "${mrs_file}")
              echo "- $(basename "${mrs_file}") (${file_size} 字节)" >> release_body.md
            fi
          done
          
          if [ -f "logs/convert.log" ]; then
            echo -e "\n转换日志摘要:" >> release_body.md
            echo '```' >> release_body.md
            tail -20 logs/convert.log >> release_body.md
            echo '```' >> release_body.md
          fi
          
          echo -e "\n注意：某些规则可能因格式问题转换失败，请检查源文件格式。" >> release_body.md

      - name: 创建版本发布
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ruleset-$(date +%Y%m%d-%H%M)
          name: "规则集 $(date +%Y-%m-%d)"
          body_path: release_body.md
          files: mrs/*.mrs
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: 提交变更到仓库
        if: success()
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add yaml/ mrs/ logs/
          
          if git diff --cached --quiet; then
            echo "无变更需要提交"
          else
            git commit -m "自动更新规则集 [$(date +%Y%m%d)]"
            git push
          fi

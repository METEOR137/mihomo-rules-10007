name: 更新并转换规则集
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  MIHOMO_VERSION: "v1.19.15"
  TZ: "Asia/Shanghai"

jobs:
  process-and-convert:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 创建目录结构
        run: |
          mkdir -p {hosts,yaml,mrs,logs}

      - name: 下载hosts源文件
        run: |
          curl -fLsS -o hosts/10007hosts.txt \
            https://raw.githubusercontent.com/lingeringsound/10007/main/all
        continue-on-error: false

      - name: 转换hosts为YAML格式
        run: |
          {
            echo "payload:"
            grep '^0\.0\.0\.0' hosts/10007hosts.txt | \
            awk '{gsub(/\.$/, "", $2); print "  - "$2}' | \
            sed '/^[[:space:]]*-[[:space:]]*$/d'
          } > yaml/10007hosts.yaml
          
          if [ ! -s yaml/10007hosts.yaml ]; then
            echo "错误：YAML文件为空，可能无有效规则"
            exit 1
          fi

      - name: 下载并验证mihomo转换工具
        run: |
          MI_URL="https://github.com/MetaCubeX/mihomo/releases/download"
          MI_FILE="mihomo-linux-amd64-v3-${MIHOMO_VERSION}"
          
          echo "下载mihomo: ${MI_URL}/${MIHOMO_VERSION}/${MI_FILE}.gz"
          
          # 下载并检查文件
          curl -fLsS -o ${MI_FILE}.gz \
            ${MI_URL}/${MIHOMO_VERSION}/${MI_FILE}.gz
          
          if [ ! -f "${MI_FILE}.gz" ]; then
            echo "错误：下载失败，文件不存在"
            exit 1
          fi
          
          echo "解压文件..."
          gzip -d ${MI_FILE}.gz
          
          if [ ! -f "${MI_FILE}" ]; then
            echo "错误：解压失败，文件不存在"
            exit 1
          fi
          
          chmod +x ${MI_FILE}
          mv ${MI_FILE} mihomo
          
          echo "验证mihomo版本..."
          # 使用正确的参数 -v 来获取版本
          if ./mihomo -v 2>&1 | grep -q "mihomo"; then
            echo "✓ mihomo验证成功"
            ./mihomo -v
          else
            echo "错误：mihomo验证失败"
            ./mihomo --help
            exit 1
          fi

      - name: 执行规则集转换
        run: |
          success_count=0
          fail_count=0
          
          for yaml_file in yaml/*.yaml; do
            base_name=$(basename "$yaml_file" .yaml)
            output_file="mrs/${base_name}.mrs"
            
            echo "正在转换: ${yaml_file}"
            
            if ./mihomo convert-ruleset domain yaml "${yaml_file}" "${output_file}" 2>>logs/convert.log; then
              if [ -s "${output_file}" ]; then
                echo "✓ 成功生成: ${output_file}"
                ((success_count++))
              else
                echo "⚠ 生成文件为空，跳过"
                rm -f "${output_file}"
                ((fail_count++))
              fi
            else
              echo "✗ 转换失败: ${yaml_file}"
              ((fail_count++))
            fi
          done
          
          echo "转换完成: ${success_count} 成功, ${fail_count} 失败"
          
          if [ ${success_count} -eq 0 ]; then
            echo "无成功转换文件，任务终止"
            exit 1
          fi

      - name: 准备发布内容
        run: |
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          
          cat > release_body.md <<EOF
          规则集自动转换结果
          生成时间: ${CURRENT_TIME}
          
          包含文件:
          EOF
          
          for mrs_file in mrs/*.mrs; do
            if [ -f "${mrs_file}" ]; then
              echo "- $(basename "${mrs_file}")" >> release_body.md
            fi
          done
          
          if [ -f "logs/convert.log" ]; then
            echo -e "\n转换日志摘要:" >> release_body.md
            tail -20 logs/convert.log | sed 's/^/  /' >> release_body.md
          fi

      - name: 创建版本发布
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ruleset-$(date +%Y%m%d-%H%M)
          name: "规则集 $(date +%Y-%m-%d)"
          body_path: release_body.md
          files: mrs/*.mrs
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 提交变更到仓库
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add yaml/ mrs/ logs/
          
          if git diff --cached --quiet; then
            echo "无变更需要提交"
          else
            git commit -m "自动更新规则集 [$(date +%Y%m%d)]"
            git push
          fi
